<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* 响应式设计*/
        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 14px;
            }
            
            .container {
                padding: 15px;
                border-radius: 8px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            h2 {
                font-size: 1.2em;
                margin-bottom: 15px;
            }
            
            .section {
                margin-bottom: 25px;
            }
            
            #employeeCount {
                font-size: 16px;
                padding: 10px 15px;
                width: 100%;
                margin-bottom: 15px;
            }
            
            .employee-input {
                flex-direction: column;
                gap: 10px;
            }
            
            .employee-input input {
                font-size: 16px;
                padding: 12px;
                border-radius: 8px;
            }
            
            button {
                font-size: 16px;
                padding: 14px 28px;
                width: 100%;
                margin-bottom: 12px;
                border-radius: 25px;
                touch-action: manipulation;
            }
            
            .shift-types {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .shift-types label {
                font-size: 16px;
                padding: 12px 15px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
                transition: all 0.3s ease;
            }
            
            .shift-types label input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-right: 10px;
            }
            
            /* 表格容器自适应 */
            .schedule-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            /* 调整表格大小以适应屏幕 */
            table {
                font-size: 14px;
                border-radius: 8px;
                width: 100%;
                transform: scale(1);
                transform-origin: top center;
            }
            
            th, td {
                padding: 12px 6px;
                min-width: 80px;
                border: 1px solid #e0e0e0;
            }
            
            .diagonal-cell {
                height: 80px;
                width: 80px;
            }
            
            .diagonal-name, .diagonal-date {
                font-size: 12px;
                padding: 4px;
            }
            
            .shift-morning, .shift-evening, .shift-full, .shift-rest {
                padding: 10px 14px;
                font-size: 14px;
                border-radius: 12px;
                display: inline-block;
                text-align: center;
                white-space: nowrap;
                font-weight: 600;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                border-width: 1px;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .stat-item {
                text-align: center;
                padding: 12px;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            
            .stat-item .label {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .stat-item .value {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            h2 {
                font-size: 1.1em;
            }
            
            /* 调整表格大小以适应小屏幕*/
            table {
                font-size: 12px;
                transform: scale(0.95);
                transform-origin: top center;
                margin: 0;
            }
            
            th, td {
                padding: 8px 4px;
                min-width: 70px;
                border: 1px solid #e0e0e0;
            }
            
            .shift-morning, .shift-evening, .shift-full, .shift-rest {
                padding: 6px 8px;
                font-size: 12px;
                border-radius: 8px;
                font-weight: 600;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                border-width: 1px;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-item .label {
                font-size: 14px;
            }
            
            .stat-item .value {
                font-size: 20px;
            }
            
            /* 优化移动端表格头部显示*/
            table th {
                font-size: 11px;
            }
            
            /* 优化角落单元�?*/
            .diagonal-cell {
                height: 70px;
                width: 70px;
            }
            
            .diagonal-name, .diagonal-date {
                font-size: 11px;
                padding: 2px;
            }
            
            /* 优化表头日期显示 */
            table th div {
                font-size: 11px;
            }
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .employee-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .employee-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .employee-input input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }
        
        /* 优化选择器样式*/
        #employeeCount {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        #employeeCount:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }
        
        .shift-types {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .shift-types label {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background-color: #45a049;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        button[style*="background-color: #2196F3"] {
            background-color: #2196F3;
        }
        
        button[style*="background-color: #2196F3"]:hover {
            background-color: #1976D2;
        }
        
        .schedule-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        td:not(:first-child):hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: bold;
            height: 60px;
        }
        
        td {
            vertical-align: middle;
            height: 60px;
        }
        
        .diagonal-cell {
            position: relative;
            width: 80px;
            height: 80px;
            padding: 0;
            background-color: #f9f9f9;
        }
        
        .diagonal-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 48%, #ddd 48%, #ddd 52%, transparent 52%);
            z-index: 1;
        }
        
        .diagonal-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            z-index: 2;
        }
        
        .diagonal-date {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            z-index: 2;
        }
        
        .corner-year {
            display: none;
        }
        
        .shift-morning {
            background-color: #E3F2FD;
            color: #1976D2;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            box-shadow: none;
            border: none;
        }
        
        .shift-evening {
            background-color: #FFF3E0;
            color: #E65100;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            box-shadow: none;
            border: none;
        }
        
        .shift-full {
            background-color: #FCE4EC;
            color: #C2185B;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            box-shadow: none;
            border: none;
        }
        
        .shift-rest {
            background-color: #E8F5E9;
            color: #388E3C;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            box-shadow: none;
            border: none;
        }
        
        .shift-morning:hover,
        .shift-evening:hover,
        .shift-full:hover,
        .shift-rest:hover {
            transform: none;
            box-shadow: none;
            background-color: inherit;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-item .label {
            font-size: 14px;
            color: #666;
        }
        
        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>排班</h1>
        
        <div class="section">
            <h2>员工设置</h2>
            <div style="margin-bottom: 15px;">
                <label for="employeeCount">员工数量：</label>
                <select id="employeeCount" onchange="updateEmployeeInputs()">
                    <option value="2" selected>2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                </select>
            </div>
            <div id="employeeInputs">
                <div class="employee-input">
                    <input type="text" id="employee1" placeholder="员工1姓名" value="杨平">
                </div>
                <div class="employee-input">
                    <input type="text" id="employee2" placeholder="员工2姓名" value="李四">
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="generateSchedule()" style="background-color: #4CAF50;">生成排班</button>
            </div>
        </div>
        
        
        
        
        
        <div class="section">
                <h2>排班结果</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="saveWeekSchedule()" style="background-color: #2196F3; margin-right: 10px;">保存排班</button>
                    <button onclick="viewWeekSchedule()" style="background-color: #FF9800; margin-right: 10px;">查看本周排班</button>
                    <button onclick="saveScheduleScreenshot()" style="background-color: #9C27B0; margin-right: 10px;">保存排班截图</button>

                </div>
                <div class="schedule-container">
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="diagonal-cell"><span class="diagonal-name">姓名</span><span class="diagonal-date">日期</span></th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="stats" id="statsContainer">
                </div>
            </div>
    </div>
    
    <script>
        // 更新员工输入框数量
        function updateEmployeeInputs() {
            const count = parseInt(document.getElementById('employeeCount').value);
            const container = document.getElementById('employeeInputs');
            const currentCount = container.children.length;
            
            if (count > currentCount) {
                // 添加新的员工输入框
                for (let i = currentCount + 1; i <= count; i++) {
                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'employee-input';
                    inputDiv.innerHTML = `<input type="text" id="employee${i}" placeholder="员工${i}姓名">`;
                    container.appendChild(inputDiv);
                }
            } else if (count < currentCount) {
                // 移除多余的员工输入框
                for (let i = currentCount; i > count; i--) {
                    container.removeChild(container.lastChild);
                }
            }
        }

        function generateSchedule() {
            const employees = [];
            const inputs = document.querySelectorAll('#employeeInputs input');
            
            inputs.forEach((input, index) => {
                if (input.value.trim()) {
                    employees.push({
                        id: index + 1,
                        name: input.value.trim(),
                        shifts: {
                            morning: 0,
                            evening: 0,
                            full: 0,
                            rest: 0
                        }
                    });
                }
            });
            
            if (employees.length < 2) {
                alert('请至少输入两位员工姓名');
                return;
            }
            
            // 默认启用所有班次类型
            const allowMorning = true;
            const allowEvening = true;
            const allowFull = true;
            
            const daysOfWeek = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
            const schedule = [];
            
            // 生成本周的日期，从周一开始
            const today = new Date();
            const firstDayOfWeek = new Date(today);
            // 如果今天是周日，向前推6天到周一
            if (today.getDay() === 0) {
                firstDayOfWeek.setDate(today.getDate() - 6);
            } else {
                firstDayOfWeek.setDate(today.getDate() - (today.getDay() - 1));
            }
            
            // 为每个员工分配休息天
            const restDays = assignRestDays(employees.length);
            
            // 初始化班次计数器，用于平衡分配
            const morningCount = new Array(employees.length).fill(0);
            const eveningCount = new Array(employees.length).fill(0);
            // 跟踪前一天的班次
            const previousShift = new Array(employees.length).fill('');
            // 跟踪连续相同班次的天数
            const consecutiveShiftCount = new Array(employees.length).fill(0);
            
            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(firstDayOfWeek);
                currentDate.setDate(firstDayOfWeek.getDate() + day);
                
                // 获取当前日期在一周中的索引（0=周日, 1=周一, ..., 6=周六）
                const weekDay = currentDate.getDay();
                
                let dayIndex;
                if (currentDate.getDay() === 0) {
                    dayIndex = 6; // 周日对应数组最后一个元素
                } else {
                    dayIndex = currentDate.getDay() - 1; // 周一到周六对应数组前6个元素
                }
                
                const daySchedule = {
                    date: formatDate(currentDate),
                    dayOfWeek: daysOfWeek[dayIndex],
                    employees: []
                };
                
                // 分配班次给每个员工
                // 先检查今天是否有员工休息
                const hasRestToday = restDays.some(rd => rd === weekDay);
                
                // 2个员工的特殊处理
                if (employees.length === 2) {
                    if (restDays[0] === weekDay && restDays[1] === weekDay) {
                        // 都休息，不允许这种情况，重新分配
                        restDays[0] = (weekDay + 1) % 7;
                        restDays[1] = (weekDay + 2) % 7;
                    }
                    
                    if (restDays[0] === weekDay) {
                        // 员工0休息，员工1上班
                        let shiftType = 'full';
                        // 根据用户选择的班次类型确定可用的班次
                        if (!allowFull) {
                            // 如果不允许全班，根据数量平衡选择早班或晚�?
                            shiftType = morningCount[1] <= eveningCount[1] ? 'morning' : 'evening';
                            // 确保选择的班次类型是允许�?
                            if ((shiftType === 'morning' && !allowMorning) || (shiftType === 'evening' && !allowEvening)) {
                                // 如果不允许，选择另一种班�?
                                shiftType = shiftType === 'morning' ? 'evening' : 'morning';
                            }
                        }
                        
                        daySchedule.employees.push({
                            name: employees[0].name,
                            shift: 'rest'
                        });
                        daySchedule.employees.push({
                            name: employees[1].name,
                            shift: shiftType
                        });
                        
                        employees[0].shifts.rest++;
                        employees[1].shifts[shiftType]++;
                        if (shiftType === 'morning' || shiftType === 'full') morningCount[1]++;
                        if (shiftType === 'evening' || shiftType === 'full') eveningCount[1]++;
                    } else if (restDays[1] === weekDay) {
                        // 员工1休息，员工0上班
                        let shiftType = 'full';
                        // 根据用户选择的班次类型确定可用的班次
                        if (!allowFull) {
                            // 如果不允许全班，根据数量平衡选择早班或晚�?
                            shiftType = morningCount[0] <= eveningCount[0] ? 'morning' : 'evening';
                            // 确保选择的班次类型是允许�?
                            if ((shiftType === 'morning' && !allowMorning) || (shiftType === 'evening' && !allowEvening)) {
                                // 如果不允许，选择另一种班�?
                                shiftType = shiftType === 'morning' ? 'evening' : 'morning';
                            }
                        }
                        
                        daySchedule.employees.push({
                            name: employees[0].name,
                            shift: shiftType
                        });
                        daySchedule.employees.push({
                            name: employees[1].name,
                            shift: 'rest'
                        });
                        
                        employees[0].shifts[shiftType]++;
                        employees[1].shifts.rest++;
                        if (shiftType === 'morning' || shiftType === 'full') morningCount[0]++;
                        if (shiftType === 'evening' || shiftType === 'full') eveningCount[0]++;
                    } else {
                        // 都不休息，根据用户选择的班次类型分�?
                        let emp0Shift, emp1Shift;
                        
                        // 情况1：只选择了早�?
                        if (allowMorning && !allowEvening && !allowFull) {
                            // 如果只允许早班，两人都上早班
                            emp0Shift = 'morning';
                            emp1Shift = 'morning';
                        }
                        // 情况2：只选择了晚�?
                        else if (!allowMorning && allowEvening && !allowFull) {
                            // 如果只允许晚班，两人都上晚班
                            emp0Shift = 'evening';
                            emp1Shift = 'evening';
                        }
                        // 情况3：只选择了全�?
                        else if (!allowMorning && !allowEvening && allowFull) {
                            emp0Shift = 'full';
                            emp1Shift = 'full';
                        }
                        // 情况4：选择了早班和晚班
                        else if (allowMorning && allowEvening) {
                            // 分配一人早班一人晚�?
                            // 优先延续前一天的班次（支持连续排班）
                            if (day > 0) {
                                emp0Shift = previousShift[0] === 'rest' ? 'morning' : previousShift[0];
                                emp1Shift = previousShift[1] === 'rest' ? 'evening' : previousShift[1];
                                
                                // 检查是否冲突（两人不能上相同的班次�?
                                if (emp0Shift === emp1Shift) {
                                    // 如果冲突，交换其中一人的班次
                                    emp1Shift = emp1Shift === 'morning' ? 'evening' : 'morning';
                                }
                            } else {
                                // 第一天按日期轮换
                                if (day % 2 === 0) {
                                    emp0Shift = 'morning';
                                    emp1Shift = 'evening';
                                } else {
                                    emp0Shift = 'evening';
                                    emp1Shift = 'morning';
                                }
                            }
                            
                            // 检查班次数量平衡，如果差异太大则调�?
                            const morningDiff = morningCount[0] - morningCount[1];
                            if (morningDiff > 1) {
                                // 员工0早班过多，强制调�?
                                emp0Shift = 'evening';
                                emp1Shift = 'morning';
                            } else if (morningDiff < -1) {
                                // 员工1早班过多，强制调�?
                                emp0Shift = 'morning';
                                emp1Shift = 'evening';
                            }
                        }
                        // 情况5：选择了早班和全班（尽量分配一人早班一人晚班）
                        else if (allowMorning && allowFull) {
                            // 优先分配一人早班一人晚�?
                            emp0Shift = morningCount[0] <= eveningCount[0] ? 'morning' : 'evening';
                            emp1Shift = emp0Shift === 'morning' ? 'evening' : 'morning';
                            // 如果无法分配晚班（不允许），则分配全�?
                            if (emp1Shift === 'evening' && !allowEvening) {
                                emp1Shift = 'full';
                            }
                        }
                        // 情况6：选择了晚班和全班（尽量分配一人早班一人晚班）
                        else if (allowEvening && allowFull) {
                            // 优先分配一人早班一人晚�?
                            emp0Shift = morningCount[0] <= eveningCount[0] ? 'morning' : 'evening';
                            emp1Shift = emp0Shift === 'morning' ? 'evening' : 'morning';
                            // 如果无法分配早班（不允许），则分配全�?
                            if (emp1Shift === 'morning' && !allowMorning) {
                                emp1Shift = 'full';
                            }
                        }
                        // 默认情况（应该不会发生，因为已经检查过至少选择了一个班次）
                        else {
                            emp0Shift = 'morning';
                            emp1Shift = 'evening';
                        }
                        
                        // 不再检查连续排班，允许连续多天排早班或晚班
                        
                        // 检查是否会导致连续3天相同班�?
                        if (day >= 2) {
                            // 检查员�?是否即将连续3天相同班�?
                            if (previousShift[0] === emp0Shift && previousShift[0] === schedule[day-2].employees[0].shift) {
                                emp0Shift = emp0Shift === 'morning' ? 'evening' : 'morning';
                                // 确保两人班次不同
                                emp1Shift = emp1Shift === 'morning' ? 'evening' : 'morning';
                            }
                            // 检查员�?是否即将连续3天相同班�?
                            if (previousShift[1] === emp1Shift && previousShift[1] === schedule[day-2].employees[1].shift) {
                                emp1Shift = emp1Shift === 'morning' ? 'evening' : 'morning';
                                // 确保两人班次不同
                                emp0Shift = emp0Shift === 'morning' ? 'evening' : 'morning';
                            }
                        }
                        
                        // 最终安全检查：确保班次不为空且两人班次不同
                        if (!emp0Shift || !emp1Shift || emp0Shift === emp1Shift) {
                            // 如果出现问题，重置班次分�?
                            emp0Shift = 'morning';
                            emp1Shift = 'evening';
                        }
                        
                        // 分配班次
                        daySchedule.employees.push({
                            name: employees[0].name,
                            shift: emp0Shift
                        });
                        daySchedule.employees.push({
                            name: employees[1].name,
                            shift: emp1Shift
                        });
                        
                        // 更新统计
                        employees[0].shifts[emp0Shift]++;
                        employees[1].shifts[emp1Shift]++;
                        if (emp0Shift === 'morning') morningCount[0]++;
                        if (emp0Shift === 'evening') eveningCount[0]++;
                        if (emp1Shift === 'morning') morningCount[1]++;
                        if (emp1Shift === 'evening') eveningCount[1]++;
                        
                        // 更新前一天班次记�?
                        previousShift[0] = emp0Shift;
                        previousShift[1] = emp1Shift;
                    }
                } else {
                    // 多个员工情况
                    // 首先分配班次
                    const shifts = [];
                    const workingEmployees = [];
                    
                    // 收集今天不休息的员工
                    employees.forEach((employee, empIndex) => {
                        if (restDays[empIndex] === weekDay) {
                            shifts.push('rest');
                        } else {
                            workingEmployees.push(empIndex);
                            shifts.push('');
                        }
                    });
                    
                    // 为所有员工分配班次（确保每个人都有排班）
                    workingEmployees.forEach(empIndex => {
                        // 如果只有一名员工工作（有人休息时剩余员�?1�?
                        if (workingEmployees.length === 1) {
                            // 必须安排全班
                            let shiftType = 'full';
                            if (!allowFull) {
                                if (allowMorning) {
                                    shiftType = 'morning';
                                } else if (allowEvening) {
                                    shiftType = 'evening';
                                }
                            }
                            shifts[empIndex] = shiftType;
                            return;
                        }
                        
                        // 首先确保有员工上选择的班次类�?
                        let shift = '';
                        
                        // 优先分配用户选择的班次类�?
                        const hasMorning = shifts.some(s => s === 'morning');
                        const hasEvening = shifts.some(s => s === 'evening');
                        const hasFull = shifts.some(s => s === 'full');
                        
                        // 根据用户选择的班次类型组合进行处�?
                        // 情况1：选择了早班和晚班
                        if (allowMorning && allowEvening) {
                            // 优先确保有早班和晚班
                            if (!hasMorning && !hasEvening) {
                                // 找出早班最少的员工分配早班
                                let minMorningCount = Infinity;
                                let minMorningIndex = -1;
                                workingEmployees.forEach(idx => {
                                    if (morningCount[idx] < minMorningCount) {
                                        minMorningCount = morningCount[idx];
                                        minMorningIndex = idx;
                                    }
                                });
                                
                                if (minMorningIndex === empIndex) {
                                    shift = 'morning';
                                } else {
                                    // 找出晚班最少的员工分配晚班
                                    let minEveningCount = Infinity;
                                    let minEveningIndex = -1;
                                    workingEmployees.forEach(idx => {
                                        if (eveningCount[idx] < minEveningCount) {
                                            minEveningCount = eveningCount[idx];
                                            minEveningIndex = idx;
                                        }
                                    });
                                    
                                    if (minEveningIndex === empIndex) {
                                        shift = 'evening';
                                    } else {
                                        // 如果当前员工既不是早班最少也不是晚班最少，根据历史班次数量分配
                                        shift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                    }
                                }
                            } else if (!hasMorning) {
                                // 只有晚班，需要分配早�?
                                // 优先分配给早班最少的员工
                                let minMorningCount = Infinity;
                                let minMorningIndex = -1;
                                workingEmployees.forEach(idx => {
                                    if (shifts[idx] === '') {
                                        if (morningCount[idx] < minMorningCount) {
                                            minMorningCount = morningCount[idx];
                                            minMorningIndex = idx;
                                        }
                                    }
                                });
                                shift = minMorningIndex === empIndex ? 'morning' : '';
                                // 如果不是早班最少的员工，暂时不分配
                                if (shift !== 'morning' && shifts[empIndex] === '') {
                                    // 暂时跳过，让其他员工先分�?
                                    return;
                                }
                            } else if (!hasEvening) {
                                // 只有早班，需要分配晚�?
                                // 优先分配给晚班最少的员工
                                let minEveningCount = Infinity;
                                let minEveningIndex = -1;
                                workingEmployees.forEach(idx => {
                                    if (shifts[idx] === '') {
                                        if (eveningCount[idx] < minEveningCount) {
                                            minEveningCount = eveningCount[idx];
                                            minEveningIndex = idx;
                                        }
                                    }
                                });
                                shift = minEveningIndex === empIndex ? 'evening' : '';
                                // 如果不是晚班最少的员工，暂时不分配
                                if (shift !== 'evening' && shifts[empIndex] === '') {
                                    // 暂时跳过，让其他员工先分�?
                                    return;
                                }
                            } else {
                                // 早班和晚班都已有员工，根据历史班次数量分�?
                                // 优先考虑班次最不平衡的员工
                                let maxDiff = -1;
                                let targetIndex = -1;
                                let shouldAssignMorning = false;
                                
                                workingEmployees.forEach(idx => {
                                    if (shifts[idx] === '') {
                                        const diff = Math.abs(morningCount[idx] - eveningCount[idx]);
                                        if (diff > maxDiff) {
                                            maxDiff = diff;
                                            targetIndex = idx;
                                            shouldAssignMorning = morningCount[idx] < eveningCount[idx];
                                        } else if (diff === maxDiff) {
                                            // 差异相同，选择总班次少�?
                                            const total1 = morningCount[idx] + eveningCount[idx];
                                            const total2 = morningCount[targetIndex] + eveningCount[targetIndex];
                                            if (total1 < total2) {
                                                targetIndex = idx;
                                                shouldAssignMorning = morningCount[idx] < eveningCount[idx];
                                            }
                                        }
                                    }
                                });
                                
                                // 为最需要平衡的员工分配班次
                                if (targetIndex === empIndex) {
                                    shift = shouldAssignMorning ? 'morning' : 'evening';
                                } else {
                                    // 对于其他员工，继续根据历史数量分�?
                                    shift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                }
                            }
                        }
                        // 情况2：只选择了早�?
                        else if (allowMorning) {
                            shift = 'morning';
                        }
                        // 情况3：只选择了晚�?
                        else if (allowEvening) {
                            shift = 'evening';
                        }
                        // 情况4：只选择了全�?
                        else if (allowFull) {
                            shift = 'full';
                        }
                        // 情况5：选择了早班和全班
                        else if (allowMorning && allowFull) {
                            // 如果允许晚班，确保同时有早班和晚�?
                            if (allowEvening) {
                                if (!hasMorning && !hasEvening) {
                                    // 如果还没有分配任何班次，优先分配早班和晚�?
                                    shift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                } else if (!hasMorning) {
                                    // 只有晚班，需要分配早�?
                                    shift = 'morning';
                                } else if (!hasEvening) {
                                    // 只有早班，需要分配晚�?
                                    shift = 'evening';
                                } else {
                                    // 早班和晚班都已有，根据历史数量分配早班或全班
                                    shift = morningCount[empIndex] < 4 ? 'morning' : 'full';
                                }
                            } else {
                                // 不允许晚班，只能分配早班或全�?
                                shift = morningCount[empIndex] < 4 ? 'morning' : 'full';
                            }
                        }
                        // 情况6：选择了晚班和全班
                        else if (allowEvening && allowFull) {
                            // 如果允许早班，确保同时有早班和晚�?
                            if (allowMorning) {
                                if (!hasMorning && !hasEvening) {
                                    // 如果还没有分配任何班次，优先分配早班和晚�?
                                    shift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                } else if (!hasMorning) {
                                    // 只有晚班，需要分配早�?
                                    shift = 'morning';
                                } else if (!hasEvening) {
                                    // 只有早班，需要分配晚�?
                                    shift = 'evening';
                                } else {
                                    // 早班和晚班都已有，根据历史数量分配晚班或全班
                                    shift = eveningCount[empIndex] < 4 ? 'evening' : 'full';
                                }
                            } else {
                                // 不允许早班，只能分配晚班或全�?
                                shift = eveningCount[empIndex] < 4 ? 'evening' : 'full';
                            }
                        }
                        
                        // 优先延续前一天的有效班次（支持连续排班）
                        if (day > 0 && previousShift[empIndex] !== 'rest' && previousShift[empIndex] !== '') {
                            // 检查前一天的班次是否是用户选择的类�?
                            const prevShiftAllowed = (previousShift[empIndex] === 'morning' && allowMorning) ||
                                                  (previousShift[empIndex] === 'evening' && allowEvening) ||
                                                  (previousShift[empIndex] === 'full' && allowFull);
                            
                            if (prevShiftAllowed) {
                                // 检查是否会导致连续3天相同班�?
                                let isConsecutive = false;
                                if (day >= 2) {
                                    const day2Shift = schedule[day-2].employees[empIndex].shift;
                                    const day1Shift = previousShift[empIndex];
                                    if (day2Shift === day1Shift && day1Shift === shift) {
                                        isConsecutive = true;
                                    }
                                }
                                // 如果不会连续3天相同班次，延续前一天的班次
                                if (!isConsecutive) {
                                    // 但要确保不会破坏整体平衡（只对早�?晚班有效�?
                                    if (previousShift[empIndex] === 'morning' || previousShift[empIndex] === 'evening') {
                                        const morningDiff = Math.abs((morningCount[empIndex] + (previousShift[empIndex] === 'morning' ? 1 : 0)) - eveningCount[empIndex]);
                                        const eveningDiff = Math.abs(morningCount[empIndex] - (eveningCount[empIndex] + (previousShift[empIndex] === 'evening' ? 1 : 0)));
                                        
                                        // 如果延续前一天的班次不会导致差异超过1，则延续
                                        if (Math.min(morningDiff, eveningDiff) <= 1) {
                                            shift = previousShift[empIndex];
                                        }
                                    } else {
                                        // 全班直接延续
                                        shift = previousShift[empIndex];
                                    }
                                }
                            }
                        }
                        
                        // 限制每个员工的早班和晚班数量不超�?天，并确保只使用允许的班次类�?
                        if (shift === 'morning' && morningCount[empIndex] >= 4) {
                            if (allowEvening) {
                                shift = 'evening';
                            } else if (allowFull) {
                                shift = 'full';
                            }
                            // 如果只有早班允许且已满，则继续使用早班（虽然超过限制�?
                        } else if (shift === 'evening' && eveningCount[empIndex] >= 4) {
                            if (allowMorning) {
                                shift = 'morning';
                            } else if (allowFull) {
                                shift = 'full';
                            }
                            // 如果只有晚班允许且已满，则继续使用晚班（虽然超过限制�?
                        }
                        
                        // 如果早班和晚班都已经满了，分配全班（如果允许�?
                        if ((shift === 'morning' && morningCount[empIndex] >= 4 && allowFull) || 
                            (shift === 'evening' && eveningCount[empIndex] >= 4 && allowFull)) {
                            shift = 'full';
                        }
                        
                        // 确保班次类型是允许的
                        if (shift === 'morning' && !allowMorning) {
                            if (allowEvening) {
                                shift = 'evening';
                            } else if (allowFull) {
                                shift = 'full';
                            }
                        } else if (shift === 'evening' && !allowEvening) {
                            if (allowMorning) {
                                shift = 'morning';
                            } else if (allowFull) {
                                shift = 'full';
                            }
                        } else if (shift === 'full' && !allowFull) {
                            if (allowMorning && allowEvening) {
                                shift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                            } else if (allowMorning) {
                                shift = 'morning';
                            } else if (allowEvening) {
                                shift = 'evening';
                            }
                        }
                        
                        // 最终确保分配了有效的班�?
                        if (shift === '') {
                            // 绝对确保不会有空班次 - 最后一道防�?
                            if (allowMorning && allowEvening) {
                                shift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                            } else if (allowMorning) {
                                shift = 'morning';
                            } else if (allowEvening) {
                                shift = 'evening';
                            } else if (allowFull) {
                                shift = 'full';
                            }
                            // 记录这是最后的备用分配
                            console.log(`为员工${empIndex+1}分配了备用班次 ${shift}`);
                        }
                        
                        shifts[empIndex] = shift;
                    });
                    
                    // 确保所有工作员工都有分配班�?
                    workingEmployees.forEach(empIndex => {
                        if (shifts[empIndex] === '') {
                            // 没有分配到班次的员工，根据历史数量分�?
                            if (morningCount[empIndex] <= eveningCount[empIndex]) {
                                shifts[empIndex] = 'morning';
                            } else {
                                shifts[empIndex] = 'evening';
                            }
                        }
                    });
                    
                    // 新增规则：如果允许早班和晚班，那么不能全部早班或全部晚班
                    if (allowMorning && allowEvening) {
                        const morningWorkers = shifts.filter(s => s === 'morning').length;
                        const eveningWorkers = shifts.filter(s => s === 'evening').length;
                        
                        // 如果所有人都上早班
                        if (morningWorkers > 0 && eveningWorkers === 0) {
                            // 找到早班数量最多的员工，调整为晚班
                            let maxMorningCount = -1;
                            let maxMorningIndex = -1;
                            workingEmployees.forEach(empIndex => {
                                if (shifts[empIndex] === 'morning' && morningCount[empIndex] > maxMorningCount) {
                                    maxMorningCount = morningCount[empIndex];
                                    maxMorningIndex = empIndex;
                                }
                            });
                            if (maxMorningIndex !== -1) {
                                shifts[maxMorningIndex] = 'evening';
                            }
                        }
                        // 如果所有人都上晚班
                        else if (eveningWorkers > 0 && morningWorkers === 0) {
                            // 找到晚班数量最多的员工，调整为早班
                            let maxEveningCount = -1;
                            let maxEveningIndex = -1;
                            workingEmployees.forEach(empIndex => {
                                if (shifts[empIndex] === 'evening' && eveningCount[empIndex] > maxEveningCount) {
                                    maxEveningCount = eveningCount[empIndex];
                                    maxEveningIndex = empIndex;
                                }
                            });
                            if (maxEveningIndex !== -1) {
                                shifts[maxEveningIndex] = 'morning';
                            }
                        }
                    }
                    
                    // 检查是否会导致连续3天相同班�?
                    shifts.forEach((shift, empIndex) => {
                        if (shift !== 'rest' && day >= 2) {
                            // 获取该员工前两天的班�?
                            const day2Shift = schedule[day-2].employees[empIndex].shift;
                            const day1Shift = previousShift[empIndex];
                            
                            // 如果即将连续3天相同班次，则调�?
                            if (day1Shift === shift && day2Shift === shift) {
                                // 尝试切换到其他允许的班次类型
                                if (shift === 'morning') {
                                    if (allowEvening && eveningCount[empIndex] < 4) {
                                        shifts[empIndex] = 'evening';
                                    } else if (allowFull) {
                                        shifts[empIndex] = 'full';
                                    }
                                } else if (shift === 'evening') {
                                    if (allowMorning && morningCount[empIndex] < 4) {
                                        shifts[empIndex] = 'morning';
                                    } else if (allowFull) {
                                        shifts[empIndex] = 'full';
                                    }
                                } else if (shift === 'full') {
                                    // 如果是全班，尝试切换到早班或晚班（如果允许）
                                    if (allowMorning && allowEvening) {
                                        shifts[empIndex] = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                    } else if (allowMorning) {
                                        shifts[empIndex] = 'morning';
                                    } else if (allowEvening) {
                                        shifts[empIndex] = 'evening';
                                    }
                                }
                            }
                        }
                    });
                    
                    // 最终平衡调整：确保每个员工的早班和晚班数量差异不超�?（仅对同时选择早班和晚班的情况有效�?
                    if (allowMorning && allowEvening) {
                        workingEmployees.forEach(empIndex => {
                            if ((shifts[empIndex] === 'morning' || shifts[empIndex] === 'evening') && (allowMorning && allowEvening)) {
                                const expectedShift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                const currentShift = shifts[empIndex];
                                
                                // 如果当前班次与预期班次不同，且不会导致连�?天相同班次，则调�?
                                if (expectedShift !== currentShift) {
                                    let canChange = true;
                                    
                                    // 检查是否会导致连续3天相同班�?
                                    if (day >= 2) {
                                        const day2Shift = schedule[day-2].employees[empIndex].shift;
                                        const day1Shift = previousShift[empIndex];
                                        if (day2Shift === expectedShift && day1Shift === expectedShift) {
                                            canChange = false;
                                        }
                                    }
                                    
                                    if (canChange) {
                                        // 检查调整后是否会超过班次限�?
                                        if ((expectedShift === 'morning' && morningCount[empIndex] < 4) || 
                                            (expectedShift === 'evening' && eveningCount[empIndex] < 4)) {
                                            shifts[empIndex] = expectedShift;
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // 更新班次计数器、员工统计和前一天班次记�?
                    shifts.forEach((shift, empIndex) => {
                        // 确保所有员工都有有效的班次
                        if (shift === '') {
                            // 如果没有分配班次，检查该员工是否应该休息
                            if (restDays[empIndex] === weekDay) {
                                // 确实应该休息
                                shifts[empIndex] = 'rest';
                                employees[empIndex].shifts.rest++;
                            } else {
                                // 不应该休息，必须分配一个允许的工作班次
                                let assignedShift = '';
                                
                                if (allowMorning && allowEvening) {
                                    // 同时允许早班和晚班，选择数量较少�?
                                    assignedShift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                                } else if (allowMorning) {
                                    // 只允许早�?
                                    assignedShift = 'morning';
                                } else if (allowEvening) {
                                    // 只允许晚�?
                                    assignedShift = 'evening';
                                } else if (allowFull) {
                                    // 只允许全�?
                                    assignedShift = 'full';
                                }
                                
                                shifts[empIndex] = assignedShift;
                                employees[empIndex].shifts[assignedShift]++;
                                if (assignedShift === 'morning' || assignedShift === 'full') morningCount[empIndex]++;
                                if (assignedShift === 'evening' || assignedShift === 'full') eveningCount[empIndex]++;
                            }
                        } else {
                            if (shift === 'morning') morningCount[empIndex]++;
                            if (shift === 'evening') eveningCount[empIndex]++;
                            
                            employees[empIndex].shifts[shift]++;
                        }
                        
                        daySchedule.employees.push({
                            name: employees[empIndex].name,
                            shift: shifts[empIndex]
                        });
                        
                        // 更新前一天班次记�?
                        previousShift[empIndex] = shifts[empIndex];
                    });
                }
                
                // 检查是否有员工在今天没有排�?
                let hasError = false;
                daySchedule.employees.forEach((empSchedule, empIndex) => {
                    if (!empSchedule.shift) {
                        console.error(`错误：${empSchedule.name}在${daySchedule.dayOfWeek}没有排班！`);
                        hasError = true;
                        // 立即修复：为该员工分配休息或允许的工作班�?
                        if (restDays[empIndex] === weekDay) {
                            empSchedule.shift = 'rest';
                            employees[empIndex].shifts.rest++;
                        } else {
                            // 选择允许的工作班�?
                            let assignedShift = '';
                            
                            if (allowMorning && allowEvening) {
                                // 同时允许早班和晚班，选择数量较少�?
                                assignedShift = morningCount[empIndex] <= eveningCount[empIndex] ? 'morning' : 'evening';
                            } else if (allowMorning) {
                                // 只允许早�?
                                assignedShift = 'morning';
                            } else if (allowEvening) {
                                // 只允许晚�?
                                assignedShift = 'evening';
                            } else if (allowFull) {
                                // 只允许全�?
                                assignedShift = 'full';
                            }
                            
                            empSchedule.shift = assignedShift;
                            employees[empIndex].shifts[assignedShift]++;
                            if (assignedShift === 'morning' || assignedShift === 'full') morningCount[empIndex]++;
                            if (assignedShift === 'evening' || assignedShift === 'full') eveningCount[empIndex]++;
                        }
                        console.log(`已修复：${empSchedule.name}在${daySchedule.dayOfWeek}的班次为${empSchedule.shift}`);
                    }
                });
                
                schedule.push(daySchedule);
        }
        
        // 最终检查：确保所有员工在所有天都有排班
        let allScheduled = true;
        schedule.forEach((daySchedule, day) => {
            daySchedule.employees.forEach((empSchedule, empIndex) => {
                if (!empSchedule.shift) {
                    console.error(`最终检查错误：${empSchedule.name}在${daySchedule.dayOfWeek}没有排班！`);
                    allScheduled = false;
                }
            });
        });
        
        if (allScheduled) {
            console.log("✅ 所有员工在所有天都有排班");
        } else {
            console.error("❌ 存在员工在某些天没有排班的情况！");
        }

        // 保存当前排班数据到全局变量
        currentSchedule = schedule;
        currentEmployees = employees;

        displaySchedule(schedule, employees);
    }
    
    function assignRestDays(numEmployees) {
            const restDays = [];
            const days = [0, 1, 2, 3, 4, 5, 6];
            
            // 确保每天至少有一名员工工作，并且每个员工只休息一�?
            if (numEmployees <= 7) {
                // 员工数量 <= 7，确保每天最多只有一名员工休�?
                const availableDays = [...days];
                for (let i = 0; i < numEmployees; i++) {
                    const randomIndex = Math.floor(Math.random() * availableDays.length);
                    restDays.push(availableDays[randomIndex]);
                    availableDays.splice(randomIndex, 1);
                }
            } else {
                // 员工数量超过7，允许同一天有多个员工休息
                // 但要确保每天至少有一名员工工作，并且每个员工只休息一�?
                const mustWork = new Array(7).fill(false);
                const dayCounts = new Array(7).fill(0); // 记录每天休息的员工数�?
                
                // 为每个员工分配休息天
                for (let i = 0; i < numEmployees; i++) {
                    let randomDay;
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    do {
                        randomDay = days[Math.floor(Math.random() * days.length)];
                        attempts++;
                        
                        // 确保每天至少有一名员工工�?
                        if (i < 7 && !mustWork[randomDay]) {
                            // �?个员工，每个员工分配不同的休息天
                            restDays.push(randomDay);
                            mustWork[randomDay] = true;
                            dayCounts[randomDay]++;
                            break;
                        }
                        
                        // 检查是否会导致连续休息3�?
                        let isConsecutive = false;
                        if (i >= 2) {
                            if (restDays[i-1] === randomDay - 1 && restDays[i-2] === randomDay - 2) {
                                isConsecutive = true;
                            }
                            if (restDays[i-1] === randomDay + 1 && restDays[i-2] === randomDay + 2) {
                                isConsecutive = true;
                            }
                        }
                        
                        if (!isConsecutive || attempts >= maxAttempts) {
                            restDays.push(randomDay);
                            dayCounts[randomDay]++;
                            break;
                        }
                    } while (true);
                }
            }
            
            // 最终检查：确保每天至少有一名员工工�?
            const workingDays = new Array(7).fill(false);
            for (let day = 0; day < 7; day++) {
                let hasWorker = false;
                for (let i = 0; i < numEmployees; i++) {
                    if (restDays[i] !== day) {
                        hasWorker = true;
                        break;
                    }
                }
                if (!hasWorker) {
                    // 找到第一个休息在其他天的员工，让他在这天工作
                    for (let i = 0; i < numEmployees; i++) {
                        if (restDays[i] !== day) {
                            // 随机选择一个其他天作为该员工的新休息天
                            let newRestDay;
                            do {
                                newRestDay = days[Math.floor(Math.random() * days.length)];
                            } while (newRestDay === day);
                            restDays[i] = newRestDay;
                            break;
                        }
                    }
                }
            }
            
            return restDays;
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function displaySchedule(schedule, employees) {
            const table = document.getElementById('scheduleTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const container = table.parentElement;
            
            // 移除现有�?本周排班"标识
            const existingBadge = container.querySelector('.week-schedule-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // 清空现有内容
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // 创建表头�?
            const headerRow = document.createElement('tr');
            
            // 创建角落单元�?
            const cornerTh = document.createElement('th');
            cornerTh.className = 'diagonal-cell';
            cornerTh.innerHTML = '<span class="diagonal-name">姓名</span><span class="diagonal-date">日期</span>';
            headerRow.appendChild(cornerTh);
            
            // 添加星期几列标题
            schedule.forEach((day, dayIndex) => {
                const th = document.createElement('th');
                th.innerHTML = `<div style="font-weight: bold;">${day.dayOfWeek}</div><div style="font-size: 12px; color: #666;">${day.date}</div>`;
                th.style.verticalAlign = 'middle';
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            
            // 创建员工�?
            employees.forEach((employee, empIndex) => {
                const row = document.createElement('tr');
                
                // 员工姓名单元�?
                const empCell = document.createElement('td');
                empCell.textContent = employee.name;
                empCell.style.fontWeight = 'bold';
                empCell.style.verticalAlign = 'middle';
                row.appendChild(empCell);
                
                // 为每个员工添加班次单元格
                schedule.forEach((day, dayIndex) => {
                    const cell = document.createElement('td');
                    cell.style.cursor = 'pointer';
                    cell.style.userSelect = 'none';
                    
                    const shiftDiv = document.createElement('div');
                    
                    let shiftText = '';
                    let shiftClass = '';
                    
                    const shift = day.employees[empIndex].shift;
                    
                    switch(shift) {
                        case 'morning':
                            shiftText = '早班';
                            shiftClass = 'shift-morning';
                            break;
                        case 'evening':
                            shiftText = '晚班';
                            shiftClass = 'shift-evening';
                            break;
                        case 'full':
                            shiftText = '全班';
                            shiftClass = 'shift-full';
                            break;
                        case 'rest':
                            shiftText = '休息';
                            shiftClass = 'shift-rest';
                            break;
                    }
                    
                    shiftDiv.textContent = shiftText;
                    shiftDiv.className = shiftClass;
                    cell.appendChild(shiftDiv);
                    
                    // 添加点击事件
                    cell.addEventListener('click', () => {
                        // 获取当前班次
                        const currentShift = day.employees[empIndex].shift;
                        // 定义班次顺序
                        const shiftOrder = ['morning', 'evening', 'full', 'rest'];
                        // 找到当前班次的索�?
                        const currentIndex = shiftOrder.indexOf(currentShift);
                        // 计算下一个班次的索引
                        const nextIndex = (currentIndex + 1) % shiftOrder.length;
                        // 设置新班�?
                        day.employees[empIndex].shift = shiftOrder[nextIndex];
                        
                        // 更新显示
                        let newShiftText = '';
                        let newShiftClass = '';
                        
                        switch(shiftOrder[nextIndex]) {
                            case 'morning':
                                newShiftText = '早班';
                                newShiftClass = 'shift-morning';
                                break;
                            case 'evening':
                                newShiftText = '晚班';
                                newShiftClass = 'shift-evening';
                                break;
                            case 'full':
                                newShiftText = '全班';
                                newShiftClass = 'shift-full';
                                break;
                            case 'rest':
                                newShiftText = '休息';
                                newShiftClass = 'shift-rest';
                                break;
                        }
                        
                        shiftDiv.textContent = newShiftText;
                        shiftDiv.className = newShiftClass;
                        
                        // 更新员工统计信息
                        updateEmployeeStats(employees[empIndex], dayIndex, currentShift, shiftOrder[nextIndex]);
                        // 重新显示统计信息
                        displayStats(employees);
                    });
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            
            displayStats(employees);
        }
        
        function updateEmployeeStats(employee, dayIndex, oldShift, newShift) {
            // 减少旧班次的计数
            if (employee.shifts[oldShift] > 0) {
                employee.shifts[oldShift]--;
            }
            
            // 增加新班次的计数
            employee.shifts[newShift]++;
        }
        
        function displayStats(employees) {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = '';
            
            employees.forEach(employee => {
                const totalShifts = employee.shifts.morning + employee.shifts.evening + employee.shifts.full;
                const statDiv = document.createElement('div');
                statDiv.className = 'stat-item';
                
                statDiv.innerHTML = `
                    <div class="label">${employee.name}</div>
                    <div class="value">${totalShifts}</div>
                    <div style="font-size: 12px; color: #999;">
                        早班: ${employee.shifts.morning} | 晚班: ${employee.shifts.evening} | 全班: ${employee.shifts.full} | 休息: ${employee.shifts.rest}
                    </div>
                `;
                
                statsContainer.appendChild(statDiv);
            });
        }
        
        // 全局变量，用于存储当前排班数�?
        let currentSchedule = [];
        let currentEmployees = [];
        
        // 保存排班数据到本地存�?
        function saveWeekSchedule() {
            if (currentSchedule.length === 0 || currentEmployees.length === 0) {
                alert('没有可保存的排班数据，请先生成排班表。');
                return;
            }
            
            // 创建要保存的数据对象
            const scheduleData = {
                id: Date.now(), // 使用时间戳作为唯一ID
                date: new Date().toISOString(),
                employees: currentEmployees.map(emp => ({
                    id: emp.id,
                    name: emp.name,
                    shifts: emp.shifts
                })),
                schedule: currentSchedule
            };
            
            // 保存到本地存储（只保存最新的排班数据�?
            localStorage.setItem('currentWeekSchedule', JSON.stringify(scheduleData));
            
            alert('排班数据保存成功。');
        }
        
        // 查看本周排班
        function viewWeekSchedule() {
            // 从本地存储获取保存的本周排班数据
            const savedSchedule = JSON.parse(localStorage.getItem('currentWeekSchedule') || 'null');
            
            if (!savedSchedule) {
                alert('没有找到本周排班数据，请先保存排班表。');
                return;
            }
            
            // 更新全局变量
            currentSchedule = savedSchedule.schedule;
            currentEmployees = savedSchedule.employees;
            
            // 显示排班�?
            displaySchedule(currentSchedule, currentEmployees);
            
            // 添加"本周排班"标识
            const table = document.getElementById('scheduleTable');
            const container = table.parentElement;
            const existingBadge = container.querySelector('.week-schedule-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            const badge = document.createElement('div');
            badge.className = 'week-schedule-badge';
            badge.style.cssText = `background-color: #FF9800; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; text-align: center; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);`;
            badge.textContent = '本周排班';
            container.insertBefore(badge, table);
        }
        
        // 保存排班截图
        function saveScheduleScreenshot() {
            const scheduleContainer = document.querySelector('.schedule-container');
            
            if (!scheduleContainer) {
                alert('没有找到排班表格，请先生成排班表。');
                return;
            }
            
            // 保存原始样式
            const originalStyle = {
                overflowX: scheduleContainer.style.overflowX,
                whiteSpace: scheduleContainer.style.whiteSpace,
                width: scheduleContainer.style.width,
                maxWidth: scheduleContainer.style.maxWidth
            };
            
            try {
                // 获取表格元素
                const table = document.getElementById('scheduleTable');
                
                // 保存表格原始样式
                const originalTableStyle = {
                    width: table.style.width,
                    transform: table.style.transform,
                    fontSize: table.style.fontSize,
                    margin: table.style.margin
                };
                
                // 暂时修改容器样式，确保表格完整显示
                scheduleContainer.style.overflowX = 'visible';
                scheduleContainer.style.whiteSpace = 'nowrap';
                scheduleContainer.style.width = '100%';
                scheduleContainer.style.maxWidth = 'none';
                
                // 确保表格能完整显示，移除所有可能影响宽度的样式
                table.style.width = 'auto';
                table.style.transform = 'none';
                table.style.fontSize = '';
                table.style.margin = '0';
                
                // 强制重排，确保获取正确的尺寸
                scheduleContainer.offsetHeight;
                table.offsetHeight;
                
                // 计算实际需要的宽度和高度
                const tableWidth = table.scrollWidth || table.offsetWidth;
                const tableHeight = table.scrollHeight || table.offsetHeight;
                
                // 再次调整容器宽度以确保完全包含表格
                scheduleContainer.style.width = tableWidth + 'px';
                
                // 使用setTimeout确保DOM更新完成
                setTimeout(() => {
                    // 使用html2canvas库将表格转换为图片，简化配置以提高移动端兼容性
                    html2canvas(scheduleContainer, {
                        backgroundColor: '#ffffff',
                        scale: window.devicePixelRatio || 1, // 适配设备像素比
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        // 移除可能在移动端不兼容的配置
                        // foreignObjectRendering: true,
                        scrollX: 0,
                        scrollY: 0,
                        // 不设置固定宽度和高度，让html2canvas自动计算
                        ignoreElements: (element) => {
                            return element.classList.contains('week-schedule-badge');
                        }
                    }).then(canvas => {
                        try {
                            // 创建下载链接
                            const link = document.createElement('a');
                            
                            // 检查canvas是否有效
                            if (canvas.width === 0 || canvas.height === 0) {
                                throw new Error('生成的图片尺寸为0');
                            }
                            
                            link.download = `排班表_${new Date().toISOString().slice(0, 10)}.png`;
                            
                            // 使用toBlob替代toDataURL，提高移动端兼容性
                            canvas.toBlob(function(blob) {
                                if (blob) {
                                    link.href = URL.createObjectURL(blob);
                                    link.click();
                                    // 释放URL对象
                                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                                } else {
                                    throw new Error('无法生成图片Blob');
                                }
                            }, 'image/png');
                        } catch (downloadError) {
                            console.error('下载失败:', downloadError);
                            alert('下载失败，请重试。');
                        }
                    }).catch(error => {
                        console.error('截图失败:', error);
                        alert('截图失败，请重试。');
                    }).finally(() => {
                        // 恢复表格原始样式
                        table.style.width = originalTableStyle.width;
                        table.style.transform = originalTableStyle.transform;
                        table.style.fontSize = originalTableStyle.fontSize;
                        table.style.margin = originalTableStyle.margin;
                        
                        // 恢复容器原始样式
                        scheduleContainer.style.overflowX = originalStyle.overflowX;
                        scheduleContainer.style.whiteSpace = originalStyle.whiteSpace;
                        scheduleContainer.style.width = originalStyle.width;
                        scheduleContainer.style.maxWidth = originalStyle.maxWidth;
                    });
                }, 100); // 短暂延迟确保DOM更新
                
            } catch (error) {
                console.error('截图过程出错:', error);
                alert('截图失败，请重试。');
                // 确保恢复原始样式
                scheduleContainer.style.overflowX = originalStyle.overflowX;
                scheduleContainer.style.whiteSpace = originalStyle.whiteSpace;
                scheduleContainer.style.width = originalStyle.width;
                if (originalStyle.maxWidth) {
                    scheduleContainer.style.maxWidth = originalStyle.maxWidth;
                }
            }
        }
        
        // 页面加载时自动生成排班表
        window.onload = function() {
            generateSchedule();
        };
    </script>
</body>
</html>



